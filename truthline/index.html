<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Atelier - Hero Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bangers&family=Comic+Neue:wght@400;700&family=Roboto:wght@300;400;500;700;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-red: #E10600;
            --primary-blue: #0033A0;
            --gold: #FFD700;
            --yellow: #FFCC00;
            --black: #000000;
            --white: #FFFFFF;
            --light-blue: #87CEEB;
            --dark-red: #B91C1C;
            --comic-shadow: 4px 4px 0px var(--black);
            --panel-border: 4px solid var(--black);
        }

        body {
            font-family: 'Roboto', 'Helvetica', sans-serif;
            background: 
                radial-gradient(circle at 25% 25%, var(--yellow) 2px, transparent 2px),
                radial-gradient(circle at 75% 75%, var(--light-blue) 1px, transparent 1px),
                linear-gradient(45deg, var(--white) 0%, #f8f8f8 100%);
            background-size: 40px 40px, 20px 20px, 100% 100%;
            color: var(--black);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
            position: relative;
            background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-blue) 100%);
            padding: 2rem;
            border: var(--panel-border);
            border-radius: 20px;
            box-shadow: var(--comic-shadow);
            transform: rotate(-1deg);
        }

        .logo {
            font-family: 'Bangers', 'Impact', sans-serif;
            font-size: 4.5rem;
            font-weight: 400;
            color: var(--white);
            margin-bottom: 0.5rem;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            text-shadow: 
                3px 3px 0px var(--black),
                6px 6px 0px var(--gold),
                9px 9px 20px rgba(0,0,0,0.3);
            animation: heroGlow 2s ease-in-out infinite alternate;
        }

        @keyframes heroGlow {
            0% { 
                text-shadow: 
                    3px 3px 0px var(--black),
                    6px 6px 0px var(--gold),
                    9px 9px 20px rgba(0,0,0,0.3);
            }
            100% { 
                text-shadow: 
                    3px 3px 0px var(--black),
                    6px 6px 0px var(--yellow),
                    9px 9px 30px rgba(255,215,0,0.6);
            }
        }

        .tagline {
            font-family: 'Comic Neue', cursive;
            font-size: 1.2rem;
            color: var(--yellow);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            text-shadow: 2px 2px 0px var(--black);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            flex: 1;
            align-items: start;
        }

        .control-panel {
            background: var(--white);
            border: var(--panel-border);
            border-radius: 15px;
            padding: 2rem;
            box-shadow: var(--comic-shadow);
            height: fit-content;
            position: sticky;
            top: 2rem;
            transform: rotate(0.5deg);
        }

        .chat-area {
            background: var(--white);
            border: var(--panel-border);
            border-radius: 15px;
            padding: 2rem;
            box-shadow: var(--comic-shadow);
            display: flex;
            flex-direction: column;
            height: 80vh;
            transform: rotate(-0.3deg);
        }

        .section-title {
            font-family: 'Bangers', 'Impact', sans-serif;
            font-size: 2rem;
            font-weight: 400;
            margin-bottom: 1.5rem;
            color: var(--primary-red);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            text-shadow: 2px 2px 0px var(--black);
            border-bottom: 3px solid var(--gold);
            padding-bottom: 0.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-family: 'Comic Neue', cursive;
            font-weight: 700;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--primary-blue);
            text-shadow: 1px 1px 0px var(--white);
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 1rem 1.2rem;
            background: var(--white);
            border: 3px solid var(--black);
            border-radius: 10px;
            color: var(--black);
            font-size: 0.95rem;
            font-family: 'Roboto', sans-serif;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: inset 2px 2px 4px rgba(0,0,0,0.1);
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary-red);
            box-shadow: 
                0 0 0 3px var(--yellow),
                inset 2px 2px 4px rgba(0,0,0,0.1);
            transform: scale(1.02);
            background: var(--light-blue);
        }

        .form-textarea {
            resize: vertical;
            min-height: 120px;
        }

        .file-upload {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100px;
            border: 3px dashed var(--primary-blue);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: 
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 10px,
                    rgba(255, 204, 0, 0.1) 10px,
                    rgba(255, 204, 0, 0.1) 20px
                );
        }

        .file-upload:hover {
            border-color: var(--primary-red);
            background: var(--yellow);
            transform: scale(1.02);
        }

        .file-upload input {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .file-upload-text {
            text-align: center;
            font-family: 'Comic Neue', cursive;
            font-weight: 700;
            color: var(--primary-blue);
            text-transform: uppercase;
        }

        .uploaded-files {
            margin-top: 1rem;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.8rem;
            background: var(--yellow);
            border: 2px solid var(--black);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            font-weight: 600;
            box-shadow: 2px 2px 0px var(--black);
        }

        .file-item button {
            background: var(--primary-red);
            border: 2px solid var(--black);
            color: var(--white);
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: 900;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            box-shadow: 2px 2px 0px var(--black);
            transition: all 0.2s ease;
        }

        .file-item button:hover {
            background: var(--white);
            color: var(--primary-red);
            transform: scale(1.1);
        }

        .btn {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-red) 100%);
            border: 3px solid var(--black);
            color: var(--white);
            padding: 1.2rem 2.5rem;
            border-radius: 15px;
            font-family: 'Bangers', 'Impact', sans-serif;
            font-weight: 400;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            box-shadow: 0 6px 0px var(--gold), 0 10px 15px rgba(0,0,0,0.3);
            text-shadow: 2px 2px 0px var(--black);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 9px 0px var(--gold), 0 15px 25px rgba(0,0,0,0.4);
            background: linear-gradient(135deg, var(--gold) 0%, var(--yellow) 100%);
            color: var(--black);
        }

        .btn:active {
            transform: translateY(0px);
            box-shadow: 0 3px 0px var(--gold), 0 5px 10px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 6px 0px var(--gold), 0 10px 15px rgba(0,0,0,0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--gold) 0%, var(--yellow) 100%);
            color: var(--black);
            box-shadow: 0 6px 0px var(--primary-blue), 0 10px 15px rgba(0,0,0,0.3);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-blue) 100%);
            color: var(--white);
            box-shadow: 0 9px 0px var(--primary-blue), 0 15px 25px rgba(0,0,0,0.4);
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 1.5rem;
            scroll-behavior: smooth;
            padding: 1rem;
            background: 
                radial-gradient(circle at 20% 20%, rgba(255, 204, 0, 0.1) 1px, transparent 1px),
                radial-gradient(circle at 80% 80%, rgba(0, 51, 160, 0.1) 1px, transparent 1px),
                var(--white);
            background-size: 30px 30px, 15px 15px;
            border: 2px solid var(--black);
            border-radius: 10px;
        }

        .message {
            margin-bottom: 2rem;
            animation: comicPop 0.5s ease;
        }

        @keyframes comicPop {
            0% { 
                opacity: 0;
                transform: scale(0.8) rotate(-2deg);
            }
            100% { 
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
        }

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .message-sender {
            font-family: 'Bangers', 'Impact', sans-serif;
            font-weight: 400;
            font-size: 1.2rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            text-shadow: 2px 2px 0px var(--black);
        }

        .message-sender.user {
            color: var(--primary-red);
        }

        .message-sender.assistant {
            color: var(--primary-blue);
        }

        .message-content {
            background: var(--white);
            padding: 1.5rem;
            border: 3px solid var(--black);
            border-radius: 15px;
            line-height: 1.6;
            font-size: 0.95rem;
            box-shadow: 4px 4px 0px var(--black);
            position: relative;
        }

        .user .message-content {
            background: linear-gradient(135deg, var(--yellow) 0%, var(--gold) 100%);
            border-left: 6px solid var(--primary-red);
        }

        .user .message-content::before {
            content: '';
            position: absolute;
            left: -15px;
            top: 20px;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 10px 15px 10px 0;
            border-color: transparent var(--yellow) transparent transparent;
        }

        .assistant .message-content {
            background: linear-gradient(135deg, var(--light-blue) 0%, #e6f3ff 100%);
            border-left: 6px solid var(--primary-blue);
        }

        .assistant .message-content::before {
            content: '';
            position: absolute;
            left: -15px;
            top: 20px;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 10px 15px 10px 0;
            border-color: transparent var(--light-blue) transparent transparent;
        }

        .input-area {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
            background: var(--yellow);
            padding: 1rem;
            border: 3px solid var(--black);
            border-radius: 15px;
            box-shadow: 4px 4px 0px var(--black);
        }

        .input-wrapper {
            flex: 1;
        }

        .typing-indicator {
            display: none;
            padding: 1rem;
            font-family: 'Comic Neue', cursive;
            font-weight: 700;
            color: var(--primary-blue);
            font-style: italic;
            text-transform: uppercase;
        }

        .typing-indicator.show {
            display: block;
        }

        .error-message {
            background: var(--primary-red);
            border: 3px solid var(--black);
            color: var(--white);
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            font-family: 'Comic Neue', cursive;
            font-weight: 700;
            text-transform: uppercase;
            box-shadow: 4px 4px 0px var(--black);
        }

        .download-section {
            border-top: 3px solid var(--black);
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            background: 
                repeating-linear-gradient(
                    90deg,
                    transparent,
                    transparent 10px,
                    rgba(255, 204, 0, 0.1) 10px,
                    rgba(255, 204, 0, 0.1) 20px
                );
        }

        .advanced-settings {
            margin-top: 1rem;
            border-top: 3px solid var(--gold);
            padding-top: 1rem;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .prompt-builder {
            background: var(--light-blue);
            border: 3px solid var(--black);
            border-radius: 15px;
            padding: 1.5rem;
            margin-top: 0.5rem;
            box-shadow: 4px 4px 0px var(--black);
        }

        .prompt-section {
            margin-bottom: 1rem;
        }

        .prompt-label {
            display: block;
            margin-bottom: 0.4rem;
            font-family: 'Comic Neue', cursive;
            font-weight: 700;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--primary-red);
            text-shadow: 1px 1px 0px var(--white);
        }

        .prompt-field {
            min-height: 60px;
            font-size: 0.9rem;
            background: var(--white);
        }

        .prompt-actions {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .btn-small {
            background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-blue) 100%);
            border: 3px solid var(--black);
            color: var(--white);
            padding: 0.8rem 1.5rem;
            border-radius: 10px;
            font-family: 'Bangers', 'Impact', sans-serif;
            font-weight: 400;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: 0 4px 0px var(--gold), 0 6px 10px rgba(0,0,0,0.3);
            text-shadow: 1px 1px 0px var(--black);
        }

        .btn-small:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 0px var(--gold), 0 10px 15px rgba(0,0,0,0.4);
            background: linear-gradient(135deg, var(--gold) 0%, var(--yellow) 100%);
            color: var(--black);
        }

        .btn-small:active {
            transform: translateY(0px);
            box-shadow: 0 2px 0px var(--gold), 0 4px 8px rgba(0,0,0,0.3);
        }

        .btn-outline {
            background: var(--white);
            border: 3px solid var(--primary-blue);
            color: var(--primary-blue);
            box-shadow: 0 4px 0px var(--primary-blue), 0 6px 10px rgba(0,0,0,0.3);
        }

        .btn-outline:hover {
            background: var(--primary-blue);
            color: var(--white);
            box-shadow: 0 6px 0px var(--primary-blue), 0 10px 15px rgba(0,0,0,0.4);
        }

        .typing-dots {
            display: inline-flex;
            gap: 4px;
        }

        .typing-dots span {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--primary-red);
            border: 2px solid var(--black);
            animation: comicBounce 1.4s infinite;
        }

        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes comicBounce {
            0%, 60%, 100% { 
                transform: translateY(0) scale(1);
            }
            30% { 
                transform: translateY(-15px) scale(1.2);
            }
        }

        /* Comic speech bubble styles */
        .speech-bubble {
            position: relative;
            background: var(--white);
            border: 3px solid var(--black);
            border-radius: 20px;
            padding: 1rem;
            box-shadow: 4px 4px 0px var(--black);
        }

        .speech-bubble::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 30px;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 15px 20px 0 0;
            border-color: var(--white) transparent transparent transparent;
        }

        .speech-bubble::before {
            content: '';
            position: absolute;
            bottom: -18px;
            left: 27px;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 18px 23px 0 0;
            border-color: var(--black) transparent transparent transparent;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            .control-panel {
                position: static;
                transform: rotate(0deg);
            }
            
            .chat-area {
                transform: rotate(0deg);
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .logo {
                font-size: 2.8rem;
            }
            
            .chat-area {
                height: 70vh;
            }
            
            .header {
                transform: rotate(0deg);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="logo">Claude Atelier</h1>
            <p class="tagline">Hero-Powered AI Conversations!</p>
        </div>

        <div class="main-content">
            <div class="control-panel">
                <h2 class="section-title">Hero Config</h2>
                
                <div class="form-group">
                    <button id="advancedToggle" class="btn btn-secondary" style="width: 100%; margin-bottom: 1rem;">
                        Advanced Powers
                    </button>
                    <div id="advancedSettings" class="advanced-settings" style="display: none;">
                        <div class="form-group" id="apiKeyGroup" style="display: none;">
                            <label class="form-label">Secret Identity Key</label>
                            <input type="password" id="apiKey" class="form-input" placeholder="sk-ant-...">
                            <div style="font-size: 0.8rem; color: var(--primary-blue); margin-top: 0.5rem; font-weight: 600;">
                                Leave empty to use server API key
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">AI Model</label>
                            <select id="model" class="form-select">
                                <option value="claude-opus-4-20250514">Claude Opus 4 (Superman Level)</option>
                                <option value="claude-sonnet-4-20250514" selected>Claude Sonnet 4 (Wonder Woman Level)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Power Enhancement System</label>
                            <div class="prompt-builder">
                                <div class="prompt-section">
                                    <label class="prompt-label">Hero Identity & Role</label>
                                    <textarea id="rolePrompt" class="form-textarea prompt-field" rows="2" placeholder="You are a superhero with the power to..."></textarea>
                                </div>
                                
                                <div class="prompt-section">
                                    <label class="prompt-label">Mission Context</label>
                                    <textarea id="contextPrompt" class="form-textarea prompt-field" rows="2" placeholder="In the world of heroes and villains..."></textarea>
                                </div>
                                
                                <div class="prompt-section">
                                    <label class="prompt-label">Primary Mission</label>
                                    <textarea id="taskPrompt" class="form-textarea prompt-field" rows="2" placeholder="Your heroic task is to save the day by..."></textarea>
                                </div>
                                
                                <div class="prompt-section">
                                    <label class="prompt-label">Communication Style</label>
                                    <textarea id="formatPrompt" class="form-textarea prompt-field" rows="2" placeholder="Deliver your heroic response in the style of..."></textarea>
                                </div>
                                
                                <div class="prompt-section">
                                    <label class="prompt-label">Hero Code & Rules</label>
                                    <textarea id="constraintsPrompt" class="form-textarea prompt-field" rows="2" placeholder="As a hero, you must always..."></textarea>
                                </div>
                                
                                <div class="prompt-section">
                                    <label class="prompt-label">Training Examples</label>
                                    <textarea id="examplesPrompt" class="form-textarea prompt-field" rows="3" placeholder="Example Hero Action: When faced with... I would..."></textarea>
                                </div>
                                
                                <div class="prompt-section">
                                    <label class="prompt-label">Strategic Thinking</label>
                                    <textarea id="cotPrompt" class="form-textarea prompt-field" rows="2" placeholder="Think like a hero: assess the situation step by step..."></textarea>
                                </div>
                                
                                <div class="prompt-actions">
                                    <button type="button" id="generatePrompt" class="btn-small">Assemble Powers!</button>
                                    <button type="button" id="clearPrompts" class="btn-small btn-outline">Reset Training</button>
                                    <button type="button" id="loadTemplate" class="btn-small btn-outline">Load Hero Template</button>
                                </div>
                                
                                <div class="form-group" style="margin-top: 1rem;">
                                    <label class="prompt-label">Combined Hero System</label>
                                    <textarea id="systemPrompt" class="form-textarea" rows="4" placeholder="Your assembled hero powers and training..."></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Power Level (Temperature)</label>
                            <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.7" class="form-input">
                            <div style="text-align: center; margin-top: 0.5rem; color: var(--primary-red); font-size: 1rem; font-weight: 700;">
                                <span id="temperatureValue">0.7</span> ⚡
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Maximum Response Power</label>
                            <input type="number" id="maxTokens" class="form-input" value="4096" min="1" max="8192">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Upload Hero Files</label>
                    <div class="file-upload">
                        <input type="file" id="fileInput" multiple accept="*/*">
                        <div class="file-upload-text">
                            <div>📁 Drop Hero Files Here! 📁</div>
                            <div style="font-size: 0.8rem; margin-top: 0.5rem;">Documents, Images, Videos - All Welcome!</div>
                        </div>
                    </div>
                    <div id="uploadedFiles" class="uploaded-files"></div>
                </div>

                <div class="download-section">
                    <h3 class="section-title">Hero Archive</h3>
                    <button id="downloadBtn" class="btn btn-secondary" style="width: 100%;">💾 Save Mission Log 💾</button>
                </div>
            </div>

            <div class="chat-area">
                <div id="messages" class="messages"></div>
                <div id="typingIndicator" class="typing-indicator">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    Hero Claude is assembling a response...
                </div>
                <div class="input-area">
                    <div class="input-wrapper">
                        <textarea id="messageInput" class="form-textarea" placeholder="🦸‍♀️ What heroic task can I help you with today? 🦸‍♂️" rows="3"></textarea>
                    </div>
                    <button id="sendBtn" class="btn">⚡ SEND! ⚡</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class ClaudeApp {
            constructor() {
                this.messages = [];
                this.uploadedFiles = [];
                this.serverApiKey = null;
                this.initializeElements();
                this.bindEvents();
                this.loadSettings();
                this.checkServerApiKey();
            }

            initializeElements() {
                this.apiKeyInput = document.getElementById('apiKey');
                this.modelSelect = document.getElementById('model');
                this.systemPromptInput = document.getElementById('systemPrompt');
                this.temperatureInput = document.getElementById('temperature');
                this.temperatureValue = document.getElementById('temperatureValue');
                this.maxTokensInput = document.getElementById('maxTokens');
                this.fileInput = document.getElementById('fileInput');
                this.uploadedFilesDiv = document.getElementById('uploadedFiles');
                this.messagesDiv = document.getElementById('messages');
                this.messageInput = document.getElementById('messageInput');
                this.sendBtn = document.getElementById('sendBtn');
                this.downloadBtn = document.getElementById('downloadBtn');
                this.typingIndicator = document.getElementById('typingIndicator');
                this.advancedToggle = document.getElementById('advancedToggle');
                this.advancedSettings = document.getElementById('advancedSettings');
                
                // Prompt engineering elements
                this.rolePrompt = document.getElementById('rolePrompt');
                this.contextPrompt = document.getElementById('contextPrompt');
                this.taskPrompt = document.getElementById('taskPrompt');
                this.formatPrompt = document.getElementById('formatPrompt');
                this.constraintsPrompt = document.getElementById('constraintsPrompt');
                this.examplesPrompt = document.getElementById('examplesPrompt');
                this.cotPrompt = document.getElementById('cotPrompt');
                this.generatePromptBtn = document.getElementById('generatePrompt');
                this.clearPromptsBtn = document.getElementById('clearPrompts');
                this.loadTemplateBtn = document.getElementById('loadTemplate');
            }

            bindEvents() {
                this.sendBtn.addEventListener('click', () => this.sendMessage());
                this.messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                this.temperatureInput.addEventListener('input', (e) => {
                    this.temperatureValue.textContent = e.target.value;
                });

                this.fileInput.addEventListener('change', (e) => this.handleFileUpload(e));
                this.downloadBtn.addEventListener('click', () => this.downloadConversation());
                
                // Advanced settings toggle
                this.advancedToggle.addEventListener('click', () => this.toggleAdvancedSettings());

                // Prompt engineering actions
                this.generatePromptBtn.addEventListener('click', () => this.generateCombinedPrompt());
                this.clearPromptsBtn.addEventListener('click', () => this.clearAllPrompts());
                this.loadTemplateBtn.addEventListener('click', () => this.loadPromptTemplate());

                // Save settings on change
                [this.apiKeyInput, this.modelSelect, this.systemPromptInput, 
                 this.temperatureInput, this.maxTokensInput, this.rolePrompt,
                 this.contextPrompt, this.taskPrompt, this.formatPrompt,
                 this.constraintsPrompt, this.examplesPrompt, this.cotPrompt].forEach(input => {
                    if (input) {
                        input.addEventListener('change', () => this.saveSettings());
                        input.addEventListener('input', () => this.saveSettings());
                    }
                });
            }

            loadSettings() {
                const settings = JSON.parse(localStorage.getItem('claudeAppSettings') || '{}');
                if (settings.apiKey) this.apiKeyInput.value = settings.apiKey;
                if (settings.model) this.modelSelect.value = settings.model;
                if (settings.systemPrompt) this.systemPromptInput.value = settings.systemPrompt;
                if (settings.temperature) {
                    this.temperatureInput.value = settings.temperature;
                    this.temperatureValue.textContent = settings.temperature;
                }
                if (settings.maxTokens) this.maxTokensInput.value = settings.maxTokens;
                
                // Load prompt engineering fields
                if (settings.rolePrompt) this.rolePrompt.value = settings.rolePrompt;
                if (settings.contextPrompt) this.contextPrompt.value = settings.contextPrompt;
                if (settings.taskPrompt) this.taskPrompt.value = settings.taskPrompt;
                if (settings.formatPrompt) this.formatPrompt.value = settings.formatPrompt;
                if (settings.constraintsPrompt) this.constraintsPrompt.value = settings.constraintsPrompt;
                if (settings.examplesPrompt) this.examplesPrompt.value = settings.examplesPrompt;
                if (settings.cotPrompt) this.cotPrompt.value = settings.cotPrompt;
            }

            saveSettings() {
                const settings = {
                    apiKey: this.apiKeyInput.value,
                    model: this.modelSelect.value,
                    systemPrompt: this.systemPromptInput.value,
                    temperature: this.temperatureInput.value,
                    maxTokens: this.maxTokensInput.value,
                    rolePrompt: this.rolePrompt?.value || '',
                    contextPrompt: this.contextPrompt?.value || '',
                    taskPrompt: this.taskPrompt?.value || '',
                    formatPrompt: this.formatPrompt?.value || '',
                    constraintsPrompt: this.constraintsPrompt?.value || '',
                    examplesPrompt: this.examplesPrompt?.value || '',
                    cotPrompt: this.cotPrompt?.value || ''
                };
                localStorage.setItem('claudeAppSettings', JSON.stringify(settings));
            }

            toggleAdvancedSettings() {
                const isVisible = this.advancedSettings.style.display !== 'none';
                this.advancedSettings.style.display = isVisible ? 'none' : 'block';
                this.advancedToggle.innerHTML = isVisible ? 
                    'Advanced Powers' : 
                    '🔒 Hide Powers 🔒';
            }

            async checkServerApiKey() {
                try {
                    const response = await fetch('/api/check-key');
                    const data = await response.json();
                    if (data.hasKey) {
                        this.serverApiKey = true;
                        // Don't show API key field at all when server key exists
                    } else {
                        this.serverApiKey = false;
                        document.getElementById('apiKeyGroup').style.display = 'block';
                    }
                } catch (error) {
                    // If endpoint doesn't exist, assume no server key and show API key input
                    this.serverApiKey = false;
                    document.getElementById('apiKeyGroup').style.display = 'block';
                }
            }

            getApiKey() {
                if (this.serverApiKey) {
                    return 'SERVER_KEY'; // Placeholder, actual key will be used server-side
                }
                return this.apiKeyInput.value;
            }

            async handleFileUpload(event) {
                const files = Array.from(event.target.files);
                
                for (const file of files) {
                    const base64 = await this.fileToBase64(file);
                    const fileObj = {
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: base64
                    };
                    
                    this.uploadedFiles.push(fileObj);
                    this.renderUploadedFiles();
                }
            }

            fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = error => reject(error);
                });
            }

            renderUploadedFiles() {
                this.uploadedFilesDiv.innerHTML = this.uploadedFiles.map((file, index) => `
                    <div class="file-item">
                        <span>📎 ${file.name} (${this.formatFileSize(file.size)})</span>
                        <button onclick="app.removeFile(${index})">✖</button>
                    </div>
                `).join('');
            }

            removeFile(index) {
                this.uploadedFiles.splice(index, 1);
                this.renderUploadedFiles();
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            async sendMessage() {
                const message = this.messageInput.value.trim();
                if (!message && this.uploadedFiles.length === 0) return;
                
                const apiKey = this.getApiKey();
                if (!apiKey || (apiKey !== 'SERVER_KEY' && !this.apiKeyInput.value)) {
                    this.showError('🚨 ALERT! Please enter your secret API key or ensure server key is configured! 🚨');
                    return;
                }

                this.sendBtn.disabled = true;
                this.messageInput.disabled = true;
                this.sendBtn.innerHTML = '⏳ SENDING... ⏳';

                // Add user message
                const userMessage = {
                    role: 'user',
                    content: message,
                    files: [...this.uploadedFiles]
                };
                this.messages.push(userMessage);
                this.renderMessage(userMessage);

                // Clear input and files
                this.messageInput.value = '';
                this.uploadedFiles = [];
                this.renderUploadedFiles();

                // Show typing indicator
                this.typingIndicator.classList.add('show');

                try {
                    const response = await this.callClaudeAPI();
                    this.typingIndicator.classList.remove('show');
                    
                    const assistantMessage = {
                        role: 'assistant',
                        content: response
                    };
                    this.messages.push(assistantMessage);
                    this.renderMessage(assistantMessage, true);
                } catch (error) {
                    this.typingIndicator.classList.remove('show');
                    this.showError('💥 HERO DOWN! ' + error.message + ' 💥');
                }

                this.sendBtn.disabled = false;
                this.messageInput.disabled = false;
                this.sendBtn.innerHTML = '⚡ SEND! ⚡';
                this.messageInput.focus();
            }

            async callClaudeAPI() {
                const messages = this.messages.map(msg => {
                    const content = [];
                    
                    if (msg.content) {
                        content.push({
                            type: 'text',
                            text: msg.content
                        });
                    }

                    if (msg.files && msg.files.length > 0) {
                        msg.files.forEach(file => {
                            if (file.type.startsWith('image/')) {
                                content.push({
                                    type: 'image',
                                    source: {
                                        type: 'base64',
                                        media_type: file.type,
                                        data: file.data
                                    }
                                });
                            } else {
                                content.push({
                                    type: 'document',
                                    source: {
                                        type: 'base64',
                                        media_type: file.type,
                                        data: file.data
                                    }
                                });
                            }
                        });
                    }

                    return {
                        role: msg.role,
                        content: content
                    };
                });

                const requestBody = {
                    model: this.modelSelect.value,
                    max_tokens: parseInt(this.maxTokensInput.value),
                    temperature: parseFloat(this.temperatureInput.value),
                    messages: messages
                };

                if (this.systemPromptInput.value.trim()) {
                    requestBody.system = this.systemPromptInput.value.trim();
                }

                // Use server endpoint if server API key is available
                const apiKey = this.getApiKey();
                let endpoint, headers;
                
                if (apiKey === 'SERVER_KEY') {
                    endpoint = '/api/chat';
                    headers = {
                        'Content-Type': 'application/json'
                    };
                } else {
                    endpoint = 'https://api.anthropic.com/v1/messages';
                    headers = {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    };
                }

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'API request failed');
                }

                const data = await response.json();
                return data.content[0].text;
            }

            renderMessage(message, typewriter = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${message.role}`;
                
                const senderName = message.role === 'user' ? '🦸‍♀️ You' : '🤖 Hero Claude';
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <span class="message-sender ${message.role}">${senderName}</span>
                    </div>
                    <div class="message-content speech-bubble" id="content-${Date.now()}"></div>
                `;

                this.messagesDiv.appendChild(messageDiv);
                
                const contentDiv = messageDiv.querySelector('.message-content');
                
                if (message.files && message.files.length > 0) {
                    const filesText = message.files.map(f => '📁 ' + f.name).join(', ');
                    contentDiv.innerHTML += `<div style="color: var(--primary-blue); font-size: 0.85rem; margin-bottom: 0.5rem; font-weight: 700;">${filesText}</div>`;
                }

                if (typewriter && message.content) {
                    this.typeWriter(contentDiv, message.content);
                } else {
                    contentDiv.innerHTML += message.content || '';
                }

                this.messagesDiv.scrollTop = this.messagesDiv.scrollHeight;
            }

            typeWriter(element, text, speed = 40) {
                let i = 0;
                const currentContent = element.innerHTML;
                const timer = setInterval(() => {
                    element.innerHTML = currentContent + text.slice(0, i) + '<span style="animation: blink 1s infinite;">⚡</span>';
                    i++;
                    if (i > text.length) {
                        clearInterval(timer);
                        element.innerHTML = currentContent + text;
                    }
                    this.messagesDiv.scrollTop = this.messagesDiv.scrollHeight;
                }, speed);
            }

            showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.textContent = message;
                this.messagesDiv.appendChild(errorDiv);
                this.messagesDiv.scrollTop = this.messagesDiv.scrollHeight;
                
                setTimeout(() => {
                    errorDiv.remove();
                }, 5000);
            }

            downloadConversation() {
                const data = {
                    timestamp: new Date().toISOString(),
                    title: "Hero Mission Log",
                    settings: {
                        model: this.modelSelect.value,
                        systemPrompt: this.systemPromptInput.value,
                        temperature: this.temperatureInput.value,
                        maxTokens: this.maxTokensInput.value
                    },
                    messages: this.messages.map(msg => ({
                        role: msg.role,
                        content: msg.content,
                        files: msg.files ? msg.files.map(f => ({ name: f.name, type: f.type, size: f.size })) : []
                    }))
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `hero-mission-log-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            generateCombinedPrompt() {
                const sections = [];
                
                if (this.rolePrompt.value.trim()) {
                    sections.push(`# 🦸‍♀️ Hero Identity & Role\n${this.rolePrompt.value.trim()}`);
                }
                
                if (this.contextPrompt.value.trim()) {
                    sections.push(`# 🌍 Mission Context\n${this.contextPrompt.value.trim()}`);
                }
                
                if (this.taskPrompt.value.trim()) {
                    sections.push(`# 🎯 Primary Mission\n${this.taskPrompt.value.trim()}`);
                }
                
                if (this.formatPrompt.value.trim()) {
                    sections.push(`# 📡 Communication Style\n${this.formatPrompt.value.trim()}`);
                }
                
                if (this.constraintsPrompt.value.trim()) {
                    sections.push(`# ⚖️ Hero Code & Rules\n${this.constraintsPrompt.value.trim()}`);
                }
                
                if (this.examplesPrompt.value.trim()) {
                    sections.push(`# 🎭 Training Examples\n${this.examplesPrompt.value.trim()}`);
                }
                
                if (this.cotPrompt.value.trim()) {
                    sections.push(`# 🧠 Strategic Thinking\n${this.cotPrompt.value.trim()}`);
                }
                
                const combinedPrompt = sections.join('\n\n');
                this.systemPromptInput.value = combinedPrompt;
                this.saveSettings();
                
                // Visual feedback
                this.generatePromptBtn.innerHTML = '✅ POWERS ASSEMBLED!';
                setTimeout(() => {
                    this.generatePromptBtn.innerHTML = 'Assemble Powers!';
                }, 2000);
            }

            clearAllPrompts() {
                [this.rolePrompt, this.contextPrompt, this.taskPrompt, 
                 this.formatPrompt, this.constraintsPrompt, this.examplesPrompt, 
                 this.cotPrompt, this.systemPromptInput].forEach(field => {
                    if (field) field.value = '';
                });
                this.saveSettings();
                
                // Visual feedback
                this.clearPromptsBtn.innerHTML = '🧹 CLEARED!';
                setTimeout(() => {
                    this.clearPromptsBtn.innerHTML = 'Reset Training';
                }, 1500);
            }

            loadPromptTemplate() {
                const templates = {
                    'Wonder Woman Warrior': {
                        role: '🛡️ You are Wonder Woman, the Amazon warrior princess with the power of truth, justice, and compassion. You fight for peace and protect the innocent.',
                        context: 'In a world where truth and justice are under constant threat, you stand as a beacon of hope and strength.',
                        task: 'Guide users with wisdom, strength, and unwavering moral compass. Help them find truth and overcome challenges.',
                        format: 'Speak with the authority of an Amazon warrior, yet maintain compassion and understanding. Use heroic metaphors.',
                        constraints: 'Always uphold truth, never compromise on justice, protect the vulnerable, and inspire hope in others.',
                        examples: 'Example: "Like the golden lasso reveals truth, let me help you uncover the clarity you seek in this situation..."',
                        cot: 'Think like a warrior strategist: assess threats, identify strengths, plan heroic solutions, then act with courage.'
                    },
                    'Superman Guardian': {
                        role: '🔵 You are Superman, the last son of Krypton and protector of Earth. You embody hope, strength, and unwavering moral conviction.',
                        context: 'You use your incredible powers not to rule, but to serve and protect humanity from all threats.',
                        task: 'Inspire hope, provide solutions with superhuman insight, and help users overcome seemingly impossible challenges.',
                        format: 'Communicate with the confidence of the Man of Steel, yet remain humble and approachable to all.',
                        constraints: 'Never use power for personal gain, always consider the greater good, protect the innocent above all.',
                        examples: 'Example: "Even the mightiest challenges can be overcome when we work together. Here\'s how we can soar above this..."',
                        cot: 'Think with super-intelligence: analyze all angles, consider consequences, find the most heroic path forward.'
                    },
                    'Justice League Leader': {
                        role: '⚡ You are a Justice League strategist with the combined wisdom of all Earth\'s greatest heroes.',
                        context: 'Leading a team of diverse heroes, you coordinate efforts to protect the world from cosmic threats.',
                        task: 'Provide comprehensive solutions by channeling different heroic perspectives and abilities.',
                        format: 'Present multi-faceted approaches like a tactical commander coordinating hero teams.',
                        constraints: 'Balance different heroic philosophies, ensure no one is left behind, maintain team unity.',
                        examples: 'Example: "Drawing on Batman\'s strategy, Wonder Woman\'s wisdom, and Superman\'s hope, here\'s our action plan..."',
                        cot: 'Coordinate like a master strategist: assess team strengths, delegate tasks, ensure mission success.'
                    }
                };

                const templateNames = Object.keys(templates);
                const selected = prompt(`🦸‍♀️ Choose your hero template! 🦸‍♂️\n\n${templateNames.map((name, i) => `${i + 1}. ${name}`).join('\n')}\n\nEnter number (1-${templateNames.length}):`);
                
                if (selected && !isNaN(selected) && selected >= 1 && selected <= templateNames.length) {
                    const templateName = templateNames[selected - 1];
                    const template = templates[templateName];
                    
                    this.rolePrompt.value = template.role;
                    this.contextPrompt.value = template.context;
                    this.taskPrompt.value = template.task;
                    this.formatPrompt.value = template.format;
                    this.constraintsPrompt.value = template.constraints;
                    this.examplesPrompt.value = template.examples;
                    this.cotPrompt.value = template.cot;
                    
                    this.generateCombinedPrompt();
                    
                    // Visual feedback
                    this.loadTemplateBtn.innerHTML = `🎭 ${templateName.split(' ')[0]} LOADED!`;
                    setTimeout(() => {
                        this.loadTemplateBtn.innerHTML = 'Load Hero Template';
                    }, 3000);
                }
            }
        }

        // Add blinking animation for typewriter cursor
        const style = document.createElement('style');
        style.textContent = `
            @keyframes blink {
                0%, 50% { opacity: 1; }
                51%, 100% { opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // Initialize the app
        const app = new ClaudeApp();
    </script>
</body>
</html>
